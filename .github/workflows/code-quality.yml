name: Code Quality

on:
  push:
    branches:
      - main
      - agent-**
  pull_request:

jobs:
  quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for console.log statements
        run: |
          echo "Checking for console.log in source files..."
          # Allow console.log in specific files
          if git grep -n 'console\.log' -- 'src/**/*.ts' 'src/**/*.tsx' \
            ':!src/test/**' \
            ':!src/server/**' \
            ':!server.cjs' > console-logs.txt 2>/dev/null; then
            echo "‚ö†Ô∏è  Found console.log statements:"
            cat console-logs.txt
            echo ""
            echo "Consider using a proper logging library or removing debug statements"
          else
            echo "‚úÖ No console.log statements in production code"
          fi

      - name: Check for TODO comments
        run: |
          echo "Checking for TODO comments..."
          if git grep -n 'TODO\|FIXME' -- '*.ts' '*.tsx' '*.js' '*.jsx' > todos.txt 2>/dev/null; then
            echo "üìù Found TODO/FIXME comments:"
            cat todos.txt
            echo ""
            echo "Consider creating GitHub issues for these items"
          else
            echo "‚úÖ No TODO/FIXME comments found"
          fi

      - name: Check file sizes
        run: |
          echo "Checking for large files..."
          find src -type f \( -name "*.ts" -o -name "*.tsx" \) -size +500k | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "‚ö†Ô∏è  Large file: $file ($size)"
          done || echo "‚úÖ No excessively large files"

      - name: Check for duplicate code
        run: |
          echo "Checking for potential code duplication..."
          # Simple duplicate detection - look for identical functions
          find src -name "*.ts" -o -name "*.tsx" | while read file; do
            # Extract function signatures and count duplicates
            grep -E '^(export )?(async )?function ' "$file" 2>/dev/null | sort | uniq -d | while read dup; do
              echo "‚ö†Ô∏è  Potential duplicate in $file: $dup"
            done
          done || echo "‚úÖ No obvious duplicates detected"

      - name: Security audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=high || {
            echo "‚ö†Ô∏è  Security vulnerabilities found"
            echo "Run 'npm audit fix' to resolve"
          }

      - name: Check dependencies
        run: |
          echo "Checking for outdated dependencies..."
          npm outdated || echo "‚úÖ All dependencies up to date"

  test-quality:
    name: Test Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check test coverage
        run: |
          echo "Running tests with coverage..."
          npm run test:coverage -- --run 2>&1 | tee coverage-output.txt || true

          # Extract coverage percentage
          if grep -q "All files" coverage-output.txt; then
            COVERAGE=$(grep "All files" coverage-output.txt | awk '{print $4}')
            echo "Test coverage: $COVERAGE"

            # Check if coverage meets threshold
            COVERAGE_NUM=$(echo $COVERAGE | sed 's/%//')
            if [ $(echo "$COVERAGE_NUM < 80" | bc) -eq 1 ]; then
              echo "‚ö†Ô∏è  Coverage below 80%: $COVERAGE"
            else
              echo "‚úÖ Good test coverage: $COVERAGE"
            fi
          fi

      - name: Check for skipped tests
        run: |
          echo "Checking for skipped tests..."
          if git grep -n 'test\.skip\|it\.skip\|describe\.skip' -- 'src/test/**/*.ts' 'src/test/**/*.tsx' > skipped.txt 2>/dev/null; then
            echo "‚ö†Ô∏è  Found skipped tests:"
            cat skipped.txt
            echo ""
            echo "Consider fixing or removing skipped tests"
          else
            echo "‚úÖ No skipped tests found"
          fi

      - name: Check for focused tests
        run: |
          echo "Checking for focused tests..."
          if git grep -n 'test\.only\|it\.only\|describe\.only' -- 'src/test/**/*.ts' 'src/test/**/*.tsx' > focused.txt 2>/dev/null; then
            echo "‚ùå Found focused tests (should not be committed):"
            cat focused.txt
            exit 1
          else
            echo "‚úÖ No focused tests found"
          fi
